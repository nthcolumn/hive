
CC = gcc
BINARY = hclient-linux

POLARSSL = ../libs/polarssl-0.14.0
INCLUDES = -I$(POLARSSL)/include -I../libs -I.
LIBPOLARSSL = $(POLARSSL)/library/libpolarssl.a

LDFLAGS = -lpthread

#CFLAGS += -Wall -Os -D_FILE_OFFSET_BITS=64 -m32
CFLAGS += -Wall -Os -m32
CFLAGS += $(INCLUDES) $(LDFLAGS)

DFLAGS = $(CFLAGS) -DDEBUG -D_DEBUG
DFLAGS += $(INCLUDES) $(LDFLAGS)

CFILES = main.c functions.c misc.c modes.c parser.c \
		trigger.c trigger_configuration.c trigger_network.c \
		trigger_protocols.c b64.c trigger_utils.c threads.c \
		string_utils.o init_strings.o init_crypto_strings.o ../libs/crypto.c $(LIBPOLARSSL)

UNPATCHED_SOLARIS_SPARC = hived-solaris-sparc-unpatched
UNPATCHED_WINDOWS_I386 = hived-windows-i386-unpatched.exe
UNPATCHED_LINUX_I386 = hived-linux-i386-unpatched

all: $(LIBPOLARSSL) hclient debug patcher

$(LIBPOLARSSL):
	make -C $(POLARSSL)/library

release: hclient

hclient: $(LIBPOLARSSL) strings
	${CC} ${CFLAGS} -o ${BINARY} ${CFILES}
	strip ${BINARY}
	md5sum ${BINARY} > ${BINARY}.md5

debug: $(LIBPOLARSSL) strings 
	${CC} ${DFLAGS} -o ${BINARY}-dbg ${CFILES}
	md5sum ${BINARY}-dbg > ${BINARY}-dbg.md5

strings: init_strings.o string_utils.o init_crypto_strings.o

init_crypto_strings.o: init_crypto_strings.c string_utils.o 
	gcc -c init_crypto_strings.c 

init_crypto_strings.c: crypto_strings.txt string_utils.o
	python mod_gen_cryptostring_header.py crypto_strings.txt CRYPTO_STRINGS

init_strings.o: init_strings.c string_utils.o
	${CC} -c init_strings.c

init_strings.c: client_strings.txt string_utils.h
	python mod_gen_string_header.py client_strings.txt CLIENT_STRINGS

string_utils.o: string_utils.c string_utils.h
	${CC} -c string_utils.c string_utils.h

patcher: $(UNPATCHED_SOLARIS_SPARC) $(UNPATCHED_LINUX_I386) $(UNPATCHED_WINDOWS_I386)
	@echo
	@echo "  Latest, unpatched builds of Solaris and Windows binaries "
	@echo "  must be present with the following naming conventions:"
	@echo "  . hived-windows-i386-unpatched.exe"
	@echo "  . hived-solaris-sparc-unpatched"
	@echo "  . hived-linux-i386-unpatched"
	@echo
	xxd -i $(UNPATCHED_WINDOWS_I386) _unpatched_windows_i386.h
	xxd -i $(UNPATCHED_SOLARIS_SPARC) _unpatched_solaris_sparc.h
	xxd -i $(UNPATCHED_LINUX_I386) _unpatched_linux_i386.h
	gcc -m32 -Os -W -Wall -I. string_utils.c patcher.c -o hive-patcher
	strip hive-patcher
	md5sum hive-patcher > hive-patcher.md5

clean:
	rm -f ${BINARY}* ${BINARY}-dbg* *.o *.a init_strings.c core
	rm -f _unpatched_solaris_sparc.h _unpatched_windows_i386.h _unpatched_linux_i386.h
	rm -f hive-patcher *PATCHED *PATCHED.exe
	rm -f *UNpatched*
	rm -f init_strings.*
	rm -f init_crypto_strings.*
	rm -f string_utils.o
	rm -f crypto_strings_main.h
	rm -f string_utils.h.*
	rm -f crypto_proj_strings.h
	make -C $(POLARSSL)/library clean

svnclean:
	rm -f *.o *.a init_strings.c core
	rm -f _unpatched_solaris_sparc.h _unpatched_windows_i386.h _unpatched_linux_i386.h
	rm -f *PATCHED *PATCHED.exe
	rm -f crypto_strings_main.h
	rm -f init_crypto_strings.c
	rm -f crypto_proj_strings.h
	rm -f string_utils.h.gch
